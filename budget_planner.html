<!doctype html>
<!-- https://github.com/twbs/examples/blob/main/starter/index.html -->
<html lang="en"> 
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Budget Planner</title> 
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    </head> 
    <body>
        <div class="container my-5">
          <h1>Budget Planner</h1>
          <div class="col-lg-8 px-0">
            <p class="fs-5">Welcome to budget planner where you can track your spending!</p>

            <hr class="col-8 my-4">

          </div>

          <div><button class="btn btn-primary" id="button-showCreate" onclick="showCreate()">Add Expense</button><br/><br/></div>
          <!-- https://www.w3schools.com/howto/howto_js_filter_table.asp -->
          <input type="text" id="tableSearch" onkeyup="searchTable()" placeholder="Search table.." title="Start typing">

          <div>
            <table class="table" id="expenseTable">
                <trhead>
                    <tr>
                        <th scope="col" onclick="sortTable(0)">Id</th>
                        <th scope="col">Date</th>
                        <th scope="col">Description</th>
                        <th scope="col">Tag</th>
                        <th scope="col">Cost</th>
                        <th scope="col">Update</th>
                        <th scope="col">Delete</th>
                    </tr>
                </trhead>
            </table>
          </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    </body>
    <script>
        function searchTable() {  //https://hakk.dev/blog/posts/html-table-filter/
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("tableSearch");
            filter = input.value.toUpperCase();
            table = document.getElementById("expenseTable");
            tr = table.getElementsByTagName("tr");
            for (i = 0; i < tr.length; i++) {
              td = tr[i].getElementsByTagName("td");
              for (var j = 0; j < td.length; j++) {
                txtValue = td[j].textContent || td[j].innerText;
                  if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                    break;
                  } else {
                    tr[i].style.display = "none";
                  }
                }
            }
        }
        function getAll(callback){ 
            $.ajax({ 
                "url": "http://127.0.0.1:5000/expenses", 
                "method":"GET", 
                "data":"", 
                "dataType": "JSON", 
                "success":function(result){ 
                    callback(result) 
          
                }, 
                "error":function(xhr,status,error){ 
                    console.log("error: "+status+" msg:"+error); 
                } 
            }); 
 
        }
        function addExpenseToTable(expense){
            var tableElement = document.getElementById('expenseTable')
            var rowElement = tableElement.insertRow(-1)
            
            rowElement.setAttribute('id',expense.expense_id)
            
            var cell1 = rowElement.insertCell(0);
            cell1.innerHTML = expense.expense_id
            var cell2 = rowElement.insertCell(1);
            cell2.innerHTML = expense.date
            var cell3 = rowElement.insertCell(2);
            cell3.innerHTML = expense.description
            var cell4 = rowElement.insertCell(3);
            cell4.innerHTML = expense.tag_name
            var cell5 = rowElement.insertCell(4);
            cell5.innerHTML = expense.cost
            var cell6 = rowElement.insertCell(5);
            cell6.innerHTML = '<button class="btn btn-secondary" onclick="showUpdate(this)">Update</button>'
            var cell7 = rowElement.insertCell(6);
            cell7.innerHTML = '<button class="btn btn-secondary" onclick=doDelete(this)>Delete</button>'

        }
        // populate the table
        function processGetAllResponse(result){
            console.log("in process")
            for (expense of result){
                displayExpense = {}
                displayExpense.expense_id = expense.expense_id
                displayExpense.date = expense.date.split(" 00:")[0] //<!-- https://www.geeksforgeeks.org/how-to-remove-time-from-date-using-javascript/ -->
                displayExpense.description = expense.description
                displayExpense.tag_name = expense.tag_name
                displayExpense.cost = expense.cost.toFixed(2) //<!-- https://www.w3schools.com/js/js_number_methods.asp -->
                addExpenseToTable(displayExpense)
            }
        }
         getAll(processGetAllResponse)     
    </script> 
</html> 